<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gakuen Empire Idle</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="left-menu">
        <div class="menu-header">
            <h1>Gakuen Empire</h1>
        </div>
        
        <div class="menu-section time-display">
            <div class="stat-row">
                <span class="label">Godzina:</span>
                <span id="current-hour">08:00</span>
            </div>
            <div class="stat-row">
                <span class="label">DzieÅ„:</span>
                <span id="current-day">PoniedziaÅ‚ek</span>
            </div>
            <div class="stat-row">
                <span class="label">Data:</span>
                <span id="current-date">1 Kwietnia 2025</span>
            </div>
        </div>

        <div class="menu-section stats-display">
            <div class="stat-row">
                <span class="label">GotÃ³wka:</span>
                <span id="money">Â¥800,000</span>
            </div>
            <div class="stat-row">
                <span class="label">DÅ‚ug:</span>
                <span id="debt">Â¥5,000,000</span>
            </div>
            <div class="stat-row">
                <span class="label">Reputacja:</span>
                <span id="reputation">45</span>
            </div>
            <div class="stat-row">
                <span class="label">Åšrednia ocen:</span>
                <span id="grades">0.0</span>
            </div>
            <div class="stat-row">
                <span class="label">Morale:</span>
                <span id="morale">65%</span>
            </div>
        </div>

        <div class="menu-section navigation">
            <button class="nav-btn active" data-page="dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-btn" data-page="girls">ğŸ‘¥ Dziewczyny</button>
            <button class="nav-btn" data-page="school">ğŸ« SzkoÅ‚a</button>
            <button class="nav-btn" data-page="business">ğŸ’¼ Biznes</button>
            <button class="nav-btn" data-page="city">ğŸŒ† Miasto</button>
            <button class="nav-btn" data-page="events">ğŸ“° Wydarzenia</button>
            <button class="nav-btn" data-page="options">âš™ï¸ Opcje</button>
        </div>

        <div class="menu-section time-controls">
            <div style="display: flex; flex-wrap: wrap;">
                <button id="pause-btn" class="time-btn" style="flex: 1 1 100%;">â–¶ Start</button>
                <button id="speed-1x" class="time-btn active">1x</button>
                <button id="speed-10x" class="time-btn">10x</button>
                <button id="speed-30x" class="time-btn">30x</button>
                <button id="speed-100x" class="time-btn">100x</button>
            </div>
        </div>

        <div class="menu-section save-controls">
            <button id="save-btn" class="action-btn">ğŸ’¾ Zapisz</button>
            <button id="load-btn" class="action-btn">ğŸ“‚ Wczytaj</button>
        </div>
    </div>

    <div id="main-content">
        <div id="page-dashboard" class="page active">
            <h2>Dashboard - Seiran Academy</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>ğŸ“‹ Status SzkoÅ‚y</h3>
                    <p>Witaj, Dyrektorze. Twoja szkoÅ‚a boryka siÄ™ z ogromnym dÅ‚ugiem w wysokoÅ›ci Â¥5,000,000.</p>
                    <p><strong>DÅ‚ug roÅ›nie:</strong> ~0.08% dziennie (~30% rocznie)</p>
                    <button onclick="payDebt(100000)" class="action-btn" style="margin-top: 15px;">SpÅ‚aÄ‡ Â¥100,000 dÅ‚ugu</button>
                    <button onclick="payDebt(500000)" class="action-btn">SpÅ‚aÄ‡ Â¥500,000 dÅ‚ugu</button>
                    <button onclick="payDebt(gameState.money)" class="action-btn">SpÅ‚aÄ‡ wszystko</button>
                </div>
                <div class="dashboard-card">
                    <h3>ğŸ’° Dzienny PrzychÃ³d</h3>
                    <p style="font-size: 2em; font-weight: bold; color: var(--accent-secondary);" id="daily-income">Â¥0</p>
                    <p id="income-breakdown"></p>
                </div>
                <div class="dashboard-card">
                    <h3>ğŸ‘¥ Aktywne Dziewczyny</h3>
                    <p style="font-size: 2em; font-weight: bold; color: var(--accent-primary);" id="active-girls">0/0</p>
                </div>
                <div class="dashboard-card">
                    <h3>ğŸ“ˆ WskazÃ³wki</h3>
                    <p>âœ“ Przypisz dziewczyny do Randek Szkolnych</p>
                    <p>âœ“ Trenuj lewdness (Â¥15k kaÅ¼dy trening)</p>
                    <p>âœ“ Czekaj na wydarzenia (losowe co kilka godzin)</p>
                    <p>âœ“ Dbaj o morale - pocieszaj gdy < 50%</p>
                </div>
            </div>
        </div>

        <div id="page-girls" class="page">
            <h2>ğŸ‘¥ ZarzÄ…dzanie Dziewczynami</h2>
            <div id="girls-list"></div>
        </div>

        <div id="page-school" class="page">
            <h2>ğŸ« ZarzÄ…dzanie SzkoÅ‚Ä…</h2>
            <div id="school-investments"></div>
        </div>

        <div id="page-business" class="page">
            <h2>ğŸ’¼ Operacje Biznesowe</h2>
            <div id="business-operations"></div>
        </div>

        <div id="page-city" class="page">
            <h2>ğŸŒ† Miasta i Lokacje</h2>
            <div id="city-locations"></div>
        </div>

        <div id="page-events" class="page">
            <h2>ğŸ“° Historia WydarzeÅ„</h2>
            <div id="events-log"></div>
        </div>

        <div id="page-options" class="page">
            <h2>âš™ï¸ Opcje</h2>
            <div style="max-width: 600px;">
                <h3>ZarzÄ…dzanie Zapisem</h3>
                <p>Gra auto-zapisuje co 7 dni.</p>
                <h3 style="margin-top: 30px; color: var(--danger);">Reset</h3>
                <button id="reset-game" class="action-btn" style="background: var(--danger);">ğŸ”„ Resetuj GrÄ™</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal">
        <div class="modal-content">
            <h3 id="event-title"></h3>
            <p id="event-description"></p>
            <div id="event-choices"></div>
        </div>
    </div>
    <script src="data/gamedata.js"></script>
    <script>

// ============================================================================
// GAME STATE
// ============================================================================

let gameState = {
    time: { hour: 8, dayOfWeek: 1, day: 1, month: 4, year: 2025 },
    money: 800000, debt: 5000000, reputation: 45, moraleTotal: 65,
    girls: [], gameSpeed: 1, isPaused: true,
    yakuzaProtection: false, profitTax: 0, risk: 15,
    unlockedJobs: ['none', 'school_dates'],
    completedEvents: [], eventLog: [], eventCooldowns: {},
    purchasedInvestments: [], nextGirlId: 4, lastEventCheck: 0
};

const TIME_PER_TICK_MS = 3000;
let gameLoopInterval;

// ============================================================================
// INIT
// ============================================================================

function initGame() {
    gameState.girls = [generateRandomGirl()];
    updateAll();
    setupUI();
    startGameLoop();
    console.log("âœ… Game ready!");
}

function setupUI() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`page-${btn.dataset.page}`).classList.add('active');
            btn.classList.add('active');
            if (btn.dataset.page === 'girls') renderGirls();
            if (btn.dataset.page === 'events') renderEventLog();
            if (btn.dataset.page === 'school') renderSchool();
            if (btn.dataset.page === 'business') renderBusiness();
            if (btn.dataset.page === 'city') renderCities();
        };
    });

    document.getElementById('pause-btn').onclick = () => {
        gameState.isPaused = !gameState.isPaused;
        document.getElementById('pause-btn').textContent = gameState.isPaused ? 'â–¶ Start' : 'â¸ Pauza';
    };

    ['1','10','30','100'].forEach(s => {
        document.getElementById(`speed-${s}x`).onclick = () => {
            gameState.gameSpeed = parseInt(s);
            document.querySelectorAll('.time-btn:not(#pause-btn)').forEach(b => b.classList.remove('active'));
            document.getElementById(`speed-${s}x`).classList.add('active');
            startGameLoop();
        };
    });

    document.getElementById('save-btn').onclick = () => saveGame();
    document.getElementById('load-btn').onclick = () => loadGame();
    document.getElementById('reset-game').onclick = () => {
        if (confirm('ResetowaÄ‡ grÄ™?')) {
            localStorage.removeItem('gakuen_save');
            location.reload();
        }
    };
}

// ============================================================================
// GAME LOOP
// ============================================================================

function startGameLoop() {
    if (gameLoopInterval) clearInterval(gameLoopInterval);
    gameLoopInterval = setInterval(() => {
        if (!gameState.isPaused) tick();
    }, TIME_PER_TICK_MS / gameState.gameSpeed);
}

function tick() {
    gameState.time.hour++;
    gameState.lastEventCheck++;

    if (gameState.time.hour >= 24) {
        gameState.time.hour = 0;
        gameState.time.dayOfWeek = (gameState.time.dayOfWeek % 7) + 1;
        gameState.time.day++;
        dailyCycle();

        if (gameState.time.day > 30) {
            gameState.time.day = 1;
            gameState.time.month++;
            if (gameState.time.month > 12) {
                gameState.time.month = 1;
                gameState.time.year++;
            }
        }
    }

    updateAll();

    // Cooldown event timers
    for (let id in gameState.eventCooldowns) {
        gameState.eventCooldowns[id]--;
        if (gameState.eventCooldowns[id] <= 0) delete gameState.eventCooldowns[id];
    }

    // Try trigger event every 3+ hours
    if (gameState.lastEventCheck >= 3 && Math.random() < 0.15) {
        triggerRandomEvent();
        gameState.lastEventCheck = 0;
    }
}

function dailyCycle() {
    let income = 0;

    gameState.girls.forEach(g => {
        if (g.currentJob && g.currentJob !== 'none') {
            income += calculateIncome(g, g.currentJob);
            const job = JOBS_DATA[g.currentJob];
            if (job.risk > 30) g.morale = Math.max(10, g.morale - Math.floor(job.risk / 20));
            if (g.morale < 30) g.loyalty = Math.max(0, g.loyalty - 2);
            else if (g.morale > 70) g.loyalty = Math.min(100, g.loyalty + 1);
        }
    });

    if (income > 0) {
        let afterTax = income;
        if (gameState.yakuzaProtection) afterTax -= Math.floor(income * gameState.profitTax / 100);
        gameState.money += afterTax;
        logEvent(`ğŸ“Š Dzienny przychÃ³d: Â¥${afterTax.toLocaleString()}`, 'income');
    }

    gameState.debt += Math.floor(gameState.debt * 0.0008);
    updateAverageMorale();

    if (gameState.time.day % 7 === 0) saveGame(true);
}

// ============================================================================
// CALCULATIONS
// ============================================================================

function calculateIncome(girl, jobKey) {
    const job = JOBS_DATA[jobKey];
    if (!job) return 0;

    let income = job.baseIncome;
    income *= (1 + girl.loyalty / 200);
    income *= (0.5 + girl.morale / 200);

    const req = job.requiredSkills || {};
    for (let skill in req) {
        if (girl.skills[skill]) income *= (1 + girl.skills[skill] / 300);
    }

    return Math.floor(income);
}

function canAssignJob(girl, jobKey) {
    const job = JOBS_DATA[jobKey];
    if (!job || !gameState.unlockedJobs.includes(jobKey)) return false;
    if (girl.lewdness < job.requiredLewdness) return false;

    const req = job.requiredSkills || {};
    for (let skill in req) {
        if ((girl.skills[skill] || 0) < req[skill]) return false;
    }
    return true;
}

function updateAverageMorale() {
    if (gameState.girls.length === 0) { gameState.moraleTotal = 0; return; }
    gameState.moraleTotal = Math.floor(gameState.girls.reduce((s,g) => s + g.morale, 0) / gameState.girls.length);
}

// ============================================================================
// UI UPDATES
// ============================================================================

let lastGirlsRender = 0;
const GIRLS_RENDER_COOLDOWN_MS = 1800;   // 1.8 sekundy

function updateAll() {
    updateTime();
    updateDashboard();

    const now = Date.now();

    if (document.getElementById('page-girls').classList.contains('active')) {
        if (now - lastGirlsRender >= GIRLS_RENDER_COOLDOWN_MS) {
            renderGirls();
            lastGirlsRender = now;
        }
    }
}

function updateTime() {
    const days = ['Ndz','Pon','Wt','Åšr','Czw','Pt','Sob'];
    const months = ['','Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','PaÅº','Lis','Gru'];
    document.getElementById('current-hour').textContent = String(gameState.time.hour).padStart(2,'0') + ':00';
    document.getElementById('current-day').textContent = days[gameState.time.dayOfWeek];
    document.getElementById('current-date').textContent = `${gameState.time.day} ${months[gameState.time.month]} ${gameState.time.year}`;
}

function updateDashboard() {
    document.getElementById('money').textContent = `Â¥${gameState.money.toLocaleString()}`;
    document.getElementById('debt').textContent = `Â¥${gameState.debt.toLocaleString()}`;
    document.getElementById('reputation').textContent = gameState.reputation;
    document.getElementById('morale').textContent = `${gameState.moraleTotal}%`;

    const avg = gameState.girls.length ? gameState.girls.reduce((s,g) => s + g.grades, 0) / gameState.girls.length : 0;
    document.getElementById('grades').textContent = avg.toFixed(1);

    const income = gameState.girls.reduce((s,g) => s + (g.currentJob !== 'none' ? calculateIncome(g, g.currentJob) : 0), 0);
    document.getElementById('daily-income').textContent = `Â¥${income.toLocaleString()}`;

    const active = gameState.girls.filter(g => g.currentJob !== 'none').length;
    document.getElementById('active-girls').textContent = `${active}/${gameState.girls.length}`;

    // Breakdown
    const breakdown = {};
    gameState.girls.forEach(g => {
        if (g.currentJob !== 'none') {
            const job = JOBS_DATA[g.currentJob].name;
            breakdown[job] = (breakdown[job] || 0) + calculateIncome(g, g.currentJob);
        }
    });
    let breakdownText = '';
    for (let job in breakdown) {
        breakdownText += `${job}: Â¥${breakdown[job].toLocaleString()}<br>`;
    }
    document.getElementById('income-breakdown').innerHTML = breakdownText || 'Brak przychodÃ³w';
}

function renderGirls() {
    const container = document.getElementById('girls-list');
    if (!gameState.girls.length) {
        container.innerHTML = '<p>Brak dziewczyn. Rekrutuj przez wydarzenia!</p>';
        return;
    }

    let html = '';
    gameState.girls.forEach(g => {
        const job = JOBS_DATA[g.currentJob];
        const income = calculateIncome(g, g.currentJob);

        html += `<div class="girl-card">
            <h3>${g.name} (${g.age} lat)</h3>
            <p><strong>${g.personality}</strong></p>
            <p><em>${g.backstory}</em></p>
            <p>Cechy: ${g.traits.join(', ')}</p>

            <div class="girl-stats">
                ${renderStat('LojalnoÅ›Ä‡', g.loyalty)}
                ${renderStat('Lewdness', g.lewdness)}
                ${renderStat('Morale', g.morale)}
                ${renderStat('Oceny', g.grades, true)}
                ${renderSkills(g.skills)}
            </div>

            <hr style="margin:15px 0;border-color:rgba(255,255,255,0.1);">

            <p><strong>Praca:</strong> ${job.name}</p>
            <p><strong>Dzienny dochÃ³d:</strong> Â¥${income.toLocaleString()}</p>

            <select onchange="changeJob(${g.id}, this.value)" style="width:100%;padding:8px;margin:10px 0;">
                ${Object.keys(JOBS_DATA).filter(j => gameState.unlockedJobs.includes(j)).map(j => {
                    const canDo = canAssignJob(g, j);
                    return `<option value="${j}" ${g.currentJob === j ? 'selected' : ''} ${!canDo ? 'disabled' : ''}>
                        ${JOBS_DATA[j].name} ${!canDo ? '(ğŸ”’)' : ''}
                    </option>`;
                }).join('')}
            </select>

            ${Object.keys(JOBS_DATA).map(j => {
                if (j === 'none' || gameState.unlockedJobs.includes(j)) return '';
                return `<p style="font-size:0.85em;color:var(--text-secondary);">ğŸ”’ ${JOBS_DATA[j].name} - odblokuj przez wydarzenia</p>`;
            }).join('')}

            <div style="display:flex;gap:5px;margin-top:10px;">
                <button onclick="trainGirl(${g.id})" class="action-btn" style="flex:1;" ${gameState.money < 15000 ? 'disabled' : ''}>
                    ğŸ“š Trening (Â¥15k)
                </button>
                <button onclick="comfortGirl(${g.id})" class="action-btn" style="flex:1;" ${g.morale >= 90 ? 'disabled' : ''}>
                    â¤ï¸ Pociesz ${g.morale >= 90 ? '(â‰¥90%)' : ''}
                </button>
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

function renderStat(label, value, noBar) {
    return `
        <div class="girl-stat">
            <span class="label">${label}:</span>
            <span class="value">${value}${noBar ? '' : '%'}</span>
        </div>
        ${noBar ? '' : `<div class="progress-bar"><div class="progress-fill" style="width:${value}%"></div></div>`}
    `;
}

function renderSkills(skills) {
    let html = '<div style="margin-top:10px;font-size:0.9em;">';
    for (let skill in skills) {
        html += `<div style="display:flex;justify-content:space-between;margin:3px 0;">
            <span style="text-transform:capitalize;">${skill}:</span>
            <span style="color:var(--accent-secondary);">${skills[skill]}</span>
        </div>`;
    }
    return html + '</div>';
}

function changeJob(girlId, jobKey) {
    const girl = gameState.girls.find(g => g.id === girlId);
    if (canAssignJob(girl, jobKey)) {
        girl.currentJob = jobKey;
        logEvent(`${girl.name} â†’ ${JOBS_DATA[jobKey].name}`, 'job');
        renderGirls();
        updateDashboard();
    }
}

function trainGirl(girlId) {
    if (gameState.money < 15000) return;
    const girl = gameState.girls.find(g => g.id === girlId);
    gameState.money -= 15000;
    const gain = 8 + Math.floor(Math.random() * 5);
    girl.lewdness = Math.min(100, girl.lewdness + gain);
    girl.morale = Math.max(0, girl.morale - 3);

    // Train random skill
    const skills = Object.keys(girl.skills);
    const skill = skills[Math.floor(Math.random() * skills.length)];
    girl.skills[skill] = Math.min(100, girl.skills[skill] + 3 + Math.floor(Math.random() * 3));

    logEvent(`${girl.name}: Lewdness +${gain}, ${skill} +trening`, 'training');
    renderGirls();
    updateDashboard();
}

function comfortGirl(girlId) {
    cooldown: 24;
    const girl = gameState.girls.find(g => g.id === girlId);
    if (girl.morale >= 90) return;
    girl.morale = Math.min(100, girl.morale + 15);
    girl.loyalty = Math.min(100, girl.loyalty + 5);
    logEvent(`PocieszyÅ‚eÅ› ${girl.name}`, 'comfort');
    renderGirls();
    updateDashboard();
}

function payDebt(amount) {
    amount = Math.min(amount, gameState.money, gameState.debt);
    if (amount <= 0) return;
    gameState.money -= amount;
    gameState.debt -= amount;
    logEvent(`SpÅ‚acono Â¥${amount.toLocaleString()} dÅ‚ugu`, 'debt');
    updateDashboard();

    if (gameState.debt <= 0) {
        alert('ğŸ‰ DÅUG SPÅACONY! Gratulacje! Teraz moÅ¼esz rozwijaÄ‡ imperium bez presji.');
        gameState.debt = 0;
    }
}

// ============================================================================
// START
// ============================================================================

document.addEventListener('DOMContentLoaded', initGame);
    </script>
    <script src="js/events.js"></script>
    <script src="js/cbs.js"></script>
    <script src="js/save.js"></script>
</body>
</html>
