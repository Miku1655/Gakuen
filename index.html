<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gakuen Empire Idle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Crimson+Pro:wght@400;600&display=swap');
        :root {
            --bg-dark: #1a1a2e;
            --bg-medium: #16213e;
            --bg-light: #0f3460;
            --accent-primary: #e94560;
            --accent-secondary: #f39c12;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --menu-width: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        #left-menu {
            width: var(--menu-width);
            background: rgba(22, 33, 62, 0.95);
            border-right: 2px solid var(--accent-primary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(233, 69, 96, 0.3);
        }
        .menu-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--accent-primary), #c23450);
            border-bottom: 3px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .menu-header h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }
        .menu-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.95em;
        }
        .stat-row .label { color: var(--text-secondary); font-weight: 300; }
        .stat-row span:last-child { font-weight: 700; color: var(--accent-secondary); }
        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            border-radius: 4px;
            margin: 5px 0;
        }
        .nav-btn:hover { background: rgba(233,69,96,0.2); border-color: var(--accent-primary); transform: translateX(5px); }
        .nav-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); font-weight: 700; }
        .time-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
            border-radius: 4px;
            flex: 1;
            margin: 3px;
        }
        .time-btn:hover { background: rgba(243,156,18,0.3); }
        .time-btn.active { background: var(--accent-secondary); font-weight: 700; }
        .action-btn {
            background: linear-gradient(135deg, var(--accent-primary), #c23450);
            border: none;
            color: white;
            padding: 12px;
            margin: 5px 0;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            border-radius: 4px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(233,69,96,0.4); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }
        .page { display: none; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5em;
            margin-bottom: 30px;
            color: var(--accent-primary);
            text-shadow: 2px 2px 10px rgba(233,69,96,0.3);
            border-bottom: 2px solid rgba(233,69,96,0.3);
            padding-bottom: 10px;
        }
        h3 { font-family: 'Crimson Pro', serif; color: var(--accent-secondary); margin: 20px 0 10px; font-size: 1.4em; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .dashboard-card {
            background: rgba(22,33,62,0.6);
            border: 1px solid rgba(233,69,96,0.3);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(233,69,96,0.4); }
        #girls-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .girl-card {
            background: rgba(22,33,62,0.8);
            border: 2px solid rgba(233,69,96,0.2);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .girl-card:hover { border-color: var(--accent-primary); box-shadow: 0 10px 30px rgba(233,69,96,0.3); }
        .girl-stats { margin: 15px 0; }
        .girl-stat { display: flex; justify-content: space-between; margin: 8px 0 3px; font-size: 0.9em; }
        .girl-stat .label { color: var(--text-secondary); }
        .girl-stat .value { color: var(--accent-secondary); font-weight: 700; }
        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0 15px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }
        .girl-card select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .choice-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(233,69,96,0.5);
            color: var(--text-primary);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border-radius: 6px;
        }
        .choice-btn:hover:not(:disabled) { background: rgba(233,69,96,0.2); border-color: var(--accent-primary); transform: translateX(10px); }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .event-log-container {
            max-height: 600px;
            overflow-y: auto;
            background: rgba(22,33,62,0.6);
            border: 1px solid rgba(233,69,96,0.3);
            border-radius: 8px;
            padding: 20px;
        }
        .event-log-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid var(--accent-primary);
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="left-menu">
    <div class="menu-header"><h1>Gakuen Empire</h1></div>

    <div class="menu-section">
        <div class="stat-row"><span class="label">Godzina:</span><span id="current-hour">08:00</span></div>
        <div class="stat-row"><span class="label">Dzie≈Ñ:</span><span id="current-day">Poniedzia≈Çek</span></div>
        <div class="stat-row"><span class="label">Data:</span><span id="current-date">1 Kwi 2025</span></div>
    </div>

    <div class="menu-section">
        <div class="stat-row"><span class="label">Got√≥wka:</span><span id="money">¬•800,000</span></div>
        <div class="stat-row"><span class="label">D≈Çug:</span><span id="debt">¬•5,000,000</span></div>
        <div class="stat-row"><span class="label">Reputacja:</span><span id="reputation">45</span></div>
        <div class="stat-row"><span class="label">Empatia:</span><span id="empathy">0 / 100</span></div>
        <div class="stat-row"><span class="label">Morale ≈õrednie:</span><span id="morale">65%</span></div>
        <div class="stat-row"><span class="label">Dziewczyny:</span><span id="girl-count">0 / 6</span></div>
    </div>

    <div class="menu-section">
        <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
        <button class="nav-btn" data-page="girls">üëß Dziewczyny</button>
        <button class="nav-btn" data-page="events">üì∞ Wydarzenia</button>
        <button class="nav-btn" data-page="options">‚öôÔ∏è Opcje</button>
    </div>

    <div class="menu-section">
        <div style="display:flex; flex-wrap:wrap; gap:4px;">
            <button id="pause-btn" class="time-btn" style="flex:1 1 100%;">‚ñ∂ Start</button>
            <button class="time-btn active" data-speed="1">1√ó</button>
            <button class="time-btn" data-speed="5">5√ó</button>
            <button class="time-btn" data-speed="10">10√ó</button>
            <button class="time-btn" data-speed="30">30√ó</button>
        </div>
    </div>

    <div class="menu-section">
        <button id="save-btn" class="action-btn">üíæ Zapisz</button>
        <button id="load-btn" class="action-btn">üìÇ Wczytaj</button>
    </div>
</div>

<div id="main-content">
    <div id="page-dashboard" class="page active">
        <h2>Dashboard ‚Äì Seiran Academy</h2>
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>Status szko≈Çy</h3>
                <p>ZarzƒÖdzasz akademiƒÖ z d≈Çugiem ¬•5,000,000.</p>
                <button class="action-btn" onclick="payDebt(100000)">Sp≈Çaƒá ¬•100,000</button>
                <button class="action-btn" onclick="payDebt(500000)">Sp≈Çaƒá ¬•500,000</button>
                <button class="action-btn" onclick="payDebt(gameState.money)">Sp≈Çaƒá ca≈Ço≈õƒá</button>
            </div>
            <div class="dashboard-card">
                <h3>Dzienny przych√≥d</h3>
                <p id="daily-income" style="font-size:2.2em; font-weight:bold; color:var(--accent-secondary);">¬•0</p>
                <p id="income-breakdown"></p>
            </div>
            <div class="dashboard-card">
                <h3>Aktywne dziewczyny</h3>
                <p id="active-girls" style="font-size:2.2em; font-weight:bold; color:var(--accent-primary);">0</p>
            </div>
        </div>
    </div>

    <div id="page-girls" class="page">
        <h2>Dziewczyny</h2>
        <div id="girls-list"></div>
    </div>

    <div id="page-events" class="page">
        <h2>Historia wydarze≈Ñ</h2>
        <div id="events-log" class="event-log-container"></div>
    </div>

    <div id="page-options" class="page">
        <h2>Opcje</h2>
        <button id="reset-game" class="action-btn" style="background:var(--danger);">Reset gry</button>
    </div>
</div>

<div id="event-modal" class="modal">
    <div class="modal-content">
        <h3 id="event-title"></h3>
        <p id="event-description" style="white-space:pre-line;"></p>
        <div id="event-choices"></div>
    </div>
</div>

<script>
// ============================================================================
// DANE STA≈ÅE
// ============================================================================

const JOBS = {
    none:          { name: "Wolne",           baseIncome: 0,    reqLewd: 0    },
    school_dates:  { name: "Randki szkolne",  baseIncome: 5000, reqLewd: 5    },
    hostess:       { name: "Hostessa",        baseIncome:15000, reqLewd:20    },
    delivery:      { name: "Delivery Health", baseIncome:30000, reqLewd:50    },
    soapland:      { name: "Soapland",        baseIncome:60000, reqLewd:70    },
};

const FIRST_NAMES = ["Aoi","Hana","Yui","Rin","Saki","Nao","Mio","Kanon","Rei","Mei","Yuna","Sakura","Haruka","Akari"];
const LAST_NAMES  = ["Tanaka","Suzuki","Yamada","Sato","Ito","Nakamura","Kobayashi","Yamamoto","Watanabe","Saito"];
const PERSONALITIES = ["Nie≈õmia≈Ça","Pewna siebie","Weso≈Ça","Cicha","Marzycielska","Buntownicza","Pracowita"];

const EVENT_DATE_RETURN = {
    id: "date_return",
    title: "Powr√≥t z randki",
    chance: 5,          // mocno obni≈ºone
    cooldown: 12,
    minJob: "school_dates"
};

const EVENT_RECRUIT = {
    id: "recruit",
    title: "Nowa uczennica",
    chance: 2.5,        // bardzo rzadko
    cooldown: 30,
    cost: 50000
};

// ============================================================================
// STAN GRY
// ============================================================================

let gameState = {
    time: { h:8, dayOfWeek:1, day:1, month:4, year:2025 },
    money: 800000,
    debt: 5000000,
    reputation: 45,
    empathy: 0,
    girls: [],
    maxGirls: 6,
    gameSpeed: 1,
    isPaused: true,
    eventCooldowns: {},
    lastEventCheck: 0,
    eventLog: []
};

const TICK_MS = 3000; // 3 s = 1 godzina przy prƒôdko≈õci 1√ó
let gameInterval;

// ============================================================================
// INICJALIZACJA
// ============================================================================

function init() {
    addRandomGirl(); // start z jednƒÖ dziewczynƒÖ
    setupUI();
    startLoop();
    updateAll();
}

function setupUI() {
    document.querySelectorAll('.nav-btn').forEach(b => {
        b.addEventListener('click', () => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`page-${b.dataset.page}`).classList.add('active');
            b.classList.add('active');
            if (b.dataset.page === 'girls') renderGirls();
            if (b.dataset.page === 'events') renderLog();
        });
    });

    document.getElementById('pause-btn').onclick = () => {
        gameState.isPaused = !gameState.isPaused;
        document.getElementById('pause-btn').textContent = gameState.isPaused ? '‚ñ∂ Start' : '‚è∏ Pauza';
    };

    document.querySelectorAll('[data-speed]').forEach(b => {
        b.onclick = () => {
            gameState.gameSpeed = Number(b.dataset.speed);
            document.querySelectorAll('[data-speed]').forEach(btn => btn.classList.remove('active'));
            b.classList.add('active');
            startLoop();
        };
    });

    document.getElementById('save-btn').onclick = saveGame;
    document.getElementById('load-btn').onclick = loadGame;
    document.getElementById('reset-game').onclick = () => {
        if (confirm("Na pewno zresetowaƒá grƒô?")) {
            localStorage.removeItem('gakuenSave');
            location.reload();
        }
    };
}

function startLoop() {
    clearInterval(gameInterval);
    gameInterval = setInterval(() => {
        if (!gameState.isPaused) tick();
    }, TICK_MS / gameState.gameSpeed);
}

// ============================================================================
// G≈Å√ìWNA PƒòTLA
// ============================================================================

function tick() {
    gameState.time.h++;
    gameState.empathy = Math.min(100, gameState.empathy + 1);
    gameState.lastEventCheck++;

    if (gameState.time.h >= 24) {
        gameState.time.h = 0;
        gameState.time.dayOfWeek = gameState.time.dayOfWeek % 7 + 1;
        gameState.time.day++;
        dailyTick();
        if (gameState.time.day > 30) {
            gameState.time.day = 1;
            gameState.time.month++;
            if (gameState.time.month > 12) {
                gameState.time.month = 1;
                gameState.time.year++;
            }
        }
    }

    // Event co ~4‚Äì8 godzin ≈õrednio
    if (gameState.lastEventCheck >= 4 && Math.random() < 0.09) {
        tryTriggerEvent();
        gameState.lastEventCheck = 0;
    }

    updateAll();
}

function dailyTick() {
    let totalIncome = 0;
    gameState.girls.forEach(g => {
        if (g.job !== 'none') {
            const inc = calculateIncome(g);
            totalIncome += inc;
            g.morale = Math.max(5, g.morale - 1.5);
        }
    });
    gameState.money += totalIncome;
    gameState.debt += Math.floor(gameState.debt * 0.0008);
}

// ============================================================================
// FUNKCJE MECHANIKI
// ============================================================================

function addRandomGirl() {
    if (gameState.girls.length >= gameState.maxGirls) return false;

    const fn = FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)];
    const ln = LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)];
    const pers = PERSONALITIES[Math.floor(Math.random() * PERSONALITIES.length)];

    const girl = {
        id: gameState.girls.length + 1,
        name: `${fn} ${ln}`,
        age: 16 + Math.floor(Math.random() * 4), // 16‚Äì19
        personality: pers,
        loyalty: 35 + Math.floor(Math.random() * 26),
        lewdness: 5 + Math.floor(Math.random() * 21),
        morale: 45 + Math.floor(Math.random() * 31),
        grades: 68 + Math.floor(Math.random() * 23),
        skills: {
            conversation: 20 + Math.floor(Math.random() * 31),
            handjob: 0,
            blowjob: 0,
            vaginal: 0,
            anal: 0,
            feet: 0
        },
        job: 'none'
    };

    gameState.girls.push(girl);
    log(`‚ú® Do≈ÇƒÖczy≈Ça: ${girl.name} (${girl.age} lat, ${pers})`);
    return true;
}

function calculateIncome(g) {
    const j = JOBS[g.job];
    if (!j) return 0;
    let inc = j.baseIncome;
    inc *= 1 + (g.lewdness / 180);
    inc *= 0.7 + (g.morale / 140);
    inc *= 0.8 + (g.loyalty / 250);
    return Math.floor(inc);
}

function canDoJob(g, jobKey) {
    const j = JOBS[jobKey];
    return j && g.lewdness >= j.reqLewd;
}

function trainLewd(gid) {
    if (gameState.money < 15000) return;
    gameState.money -= 15000;
    const g = gameState.girls.find(x => x.id === gid);
    g.lewdness = Math.min(100, g.lewdness + 7 + ~~(Math.random()*6));
    g.morale = Math.max(0, g.morale - 4);

    const sk = Object.keys(g.skills);
    const skill = sk[~~(Math.random()*sk.length)];
    g.skills[skill] = Math.min(100, (g.skills[skill]||0) + 4 + ~~(Math.random()*5));

    log(`üìö ${g.name} ‚Üí lewdness +${g.lewdness-lastLewd}, ${skill} wzr√≥s≈Ç`);
    renderGirls();
}

function comfort(gid) {
    if (gameState.empathy < 50) return;
    gameState.empathy -= 50;
    const g = gameState.girls.find(x => x.id === gid);
    g.morale = Math.min(100, g.morale + 16);
    g.loyalty = Math.min(100, g.loyalty + 7);
    log(`‚ù§Ô∏è Pocieszy≈Çe≈õ ${g.name} (-50 empatii)`);
    renderGirls();
}

function inviteHome(gid) {
    const g = gameState.girls.find(x => x.id === gid);
    let msg = "";

    if (g.lewdness < 25) {
        msg = `${g.name} przysz≈Ça na herbatƒô i pogadaƒá.\nLojalno≈õƒá +6`;
        g.loyalty += 6;
    } else if (g.lewdness < 55) {
        msg = `Lekkie pieszczoty i blisko≈õƒá‚Ä¶\nLewdness +5, Morale +9`;
        g.lewdness += 5;
        g.morale += 9;
    } else {
        msg = `Bardzo intymny wiecz√≥r‚Ä¶ ${g.name} jest wyczerpana, ale szczƒô≈õliwa.\nLewdness +12, wszystkie umiejƒôtno≈õci +4‚Äì10`;
        g.lewdness += 12;
        Object.keys(g.skills).forEach(k => {
            g.skills[k] = Math.min(100, g.skills[k] + 4 + ~~(Math.random()*7));
        });
    }

    alert(msg);
    log(`üè† Zaprosi≈Çe≈õ ${g.name} ‚Üí ${msg.split('\n')[0]}`);
    renderGirls();
}

// ============================================================================
// WYDARZENIA
// ============================================================================

function tryTriggerEvent() {
    // Powr√≥t z randki ‚Äì tylko je≈õli kto≈õ pracuje na school_dates
    if (Math.random() < EVENT_DATE_RETURN.chance / 100 &&
        !gameState.eventCooldowns[EVENT_DATE_RETURN.id])
    {
        const candidates = gameState.girls.filter(g => g.job === EVENT_DATE_RETURN.minJob);
        if (candidates.length === 0) return;

        const girl = candidates[~~(Math.random()*candidates.length)];
        showEvent(EVENT_DATE_RETURN, girl);
        gameState.eventCooldowns[EVENT_DATE_RETURN.id] = EVENT_DATE_RETURN.cooldown;
        return;
    }

    // Rekrutacja ‚Äì bardzo rzadka
    if (Math.random() < EVENT_RECRUIT.chance / 100 &&
        !gameState.eventCooldowns[EVENT_RECRUIT.id])
    {
        showEvent(EVENT_RECRUIT);
        gameState.eventCooldowns[EVENT_RECRUIT.id] = EVENT_RECRUIT.cooldown;
    }
}

function showEvent(ev, targetGirl = null) {
    let title = ev.title;
    let desc = "";

    if (ev.id === "date_return") {
        desc = `${targetGirl.name} wraca zmƒôczona z randki.\nTrzyma kopertƒô z pieniƒôdzmi.\n‚ÄûDa≈Ç radƒô‚Ä¶ ale by≈Ç bardzo nachalny.‚Äù`;
    } else if (ev.id === "recruit") {
        desc = "Nowa uczennica wyglƒÖda na zagubionƒÖ.\nZaproponowaƒá jej pracƒô? (¬•50,000)";
    }

    document.getElementById('event-title').textContent = title;
    document.getElementById('event-description').textContent = desc;

    const chDiv = document.getElementById('event-choices');
    chDiv.innerHTML = '';

    let choices = [];

    if (ev.id === "date_return") {
        choices = [
            { txt: "Przytul i pochwal", eff: () => {
                targetGirl.loyalty += 12;
                targetGirl.morale += 18;
                gameState.money += 5000;
                log(`Przytulono ${targetGirl.name} ‚Üí +lojalno≈õƒá, +morale, +¬•5000`);
            }},
            { txt: "Tylko we≈∫ pieniƒÖdze", eff: () => {
                targetGirl.loyalty -= 7;
                targetGirl.morale -= 14;
                gameState.money += 5000;
                log(`Zabrano pieniƒÖdze ${targetGirl.name} ‚Üí -lojalno≈õƒá, -morale`);
            }}
        ];
    } else if (ev.id === "recruit") {
        choices = [
            { txt: `Zrekrutuj (-¬•${EVENT_RECRUIT.cost.toLocaleString()})`, eff: () => {
                if (gameState.money < EVENT_RECRUIT.cost) return;
                gameState.money -= EVENT_RECRUIT.cost;
                addRandomGirl();
            }},
            { txt: "Zignoruj", eff: () => {} }
        ];
    }

    choices.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = c.txt;
        btn.onclick = () => {
            c.eff();
            document.getElementById('event-modal').classList.remove('active');
            gameState.isPaused = false;
            document.getElementById('pause-btn').textContent = '‚è∏ Pauza';
            updateAll();
            renderGirls();
        };
        chDiv.appendChild(btn);
    });

    document.getElementById('event-modal').classList.add('active');
    gameState.isPaused = true;
    document.getElementById('pause-btn').textContent = '‚ñ∂ Start';
}

// ============================================================================
// RENDEROWANIE
// ============================================================================

function updateAll() {
    updateHeader();
    updateDashboard();
    if (document.querySelector('#page-girls.active')) renderGirls();
    if (document.querySelector('#page-events.active')) renderLog();
}

function updateHeader() {
    const d = gameState.time;
    const days = ['Nie','Pon','Wto','≈öro','Czw','PiƒÖ','Sob'];
    const months = ['','sty','lut','mar','kwi','maj','cze','lip','sie','wrz','pa≈∫','lis','gru'];

    document.getElementById('current-hour').textContent = String(d.h).padStart(2,'0') + ':00';
    document.getElementById('current-day').textContent = days[d.dayOfWeek-1];
    document.getElementById('current-date').textContent = `${d.day} ${months[d.month]} ${d.year}`;

    document.getElementById('money').textContent = `¬•${gameState.money.toLocaleString()}`;
    document.getElementById('debt').textContent = `¬•${gameState.debt.toLocaleString()}`;
    document.getElementById('reputation').textContent = gameState.reputation;
    document.getElementById('empathy').textContent = `${gameState.empathy} / 100`;
    const avgM = gameState.girls.length ? ~~(gameState.girls.reduce((a,b)=>a+b.morale,0)/gameState.girls.length) : 0;
    document.getElementById('morale').textContent = `${avgM}%`;
    document.getElementById('girl-count').textContent = `${gameState.girls.length} / ${gameState.maxGirls}`;
}

function updateDashboard() {
    let income = 0;
    let active = 0;
    const breakdown = {};

    gameState.girls.forEach(g => {
        if (g.job !== 'none') {
            const inc = calculateIncome(g);
            income += inc;
            active++;
            const jn = JOBS[g.job].name;
            breakdown[jn] = (breakdown[jn] || 0) + inc;
        }
    });

    document.getElementById('daily-income').textContent = `¬•${income.toLocaleString()}`;

    let txt = '';
    for (let k in breakdown) txt += `${k}: ¬•${breakdown[k].toLocaleString()}<br>`;
    document.getElementById('income-breakdown').innerHTML = txt || '‚Äî';

    document.getElementById('active-girls').textContent = active;
}

function renderGirls() {
    const cont = document.getElementById('girls-list');
    cont.innerHTML = '';

    gameState.girls.forEach(g => {
        const j = JOBS[g.job] || JOBS.none;
        const inc = calculateIncome(g);

        let html = `
        <div class="girl-card">
            <h3>${g.name} (${g.age}) ‚Äì ${g.personality}</h3>
            <div class="girl-stats">
                <div class="girl-stat"><span class="label">Lojalno≈õƒá:</span><span class="value">${g.loyalty}</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width:${g.loyalty}%"></div></div>
                <div class="girl-stat"><span class="label">Lewdness:</span><span class="value">${g.lewdness}%</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width:${g.lewdness}%"></div></div>
                <div class="girl-stat"><span class="label">Morale:</span><span class="value">${g.morale}%</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width:${g.morale}%"></div></div>
            </div>
            <p><strong>Umiejƒôtno≈õci:</strong></p>
            ${Object.entries(g.skills).map(([k,v]) => `<div>${k}: ${v}</div>`).join('')}
            <p style="margin:12px 0;"><strong>Praca:</strong> ${j.name}  ‚Üí  ¬•${inc.toLocaleString()}/dzie≈Ñ</p>

            <select onchange="setJob(${g.id}, this.value)">
                ${Object.entries(JOBS).map(([k,obj]) => {
                    const can = canDoJob(g, k);
                    return `<option value="${k}" ${g.job===k?'selected':''} ${can?'':'disabled'}>
                        ${obj.name} ${can?'':'(wymagany lewdness ' + obj.reqLewd + ')'}
                    </option>`;
                }).join('')}
            </select>

            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="action-btn" onclick="trainLewd(${g.id})" ${gameState.money<15000?'disabled':''}>Trening lewdness (¬•15k)</button>
                <button class="action-btn" onclick="comfort(${g.id})" ${gameState.empathy<50?'disabled':''}>Pociesz (50 empatii)</button>
                <button class="action-btn" onclick="inviteHome(${g.id})">Zaprosiƒá do siebie</button>
            </div>
        </div>`;
        cont.insertAdjacentHTML('beforeend', html);
    });
}

function setJob(id, jobKey) {
    const g = gameState.girls.find(x => x.id === id);
    if (canDoJob(g, jobKey)) {
        g.job = jobKey;
        renderGirls();
        updateDashboard();
    }
}

function renderLog() {
    const cont = document.getElementById('events-log');
    cont.innerHTML = gameState.eventLog.map(e => `
        <div class="event-log-item">[${e.time}] ${e.msg}</div>
    `).join('') || '<p>Brak wpis√≥w</p>';
}

function log(msg) {
    const t = gameState.time;
    const ts = `${t.day}.${t.month}.${t.year} ${String(t.h).padStart(2,'0')}:00`;
    gameState.eventLog.unshift({time:ts, msg});
    if (gameState.eventLog.length > 60) gameState.eventLog.pop();
    if (document.querySelector('#page-events.active')) renderLog();
}

function payDebt(amt) {
    amt = Math.min(amt, gameState.money, gameState.debt);
    if (amt <= 0) return;
    gameState.money -= amt;
    gameState.debt -= amt;
    log(`Sp≈Çacono d≈Çug: ¬•${amt.toLocaleString()}`);
    updateAll();
}

// ============================================================================
// ZAPIS / WCZYTYWANIE
// ============================================================================

function saveGame() {
    localStorage.setItem('gakuenSave', JSON.stringify(gameState));
    alert('Zapisano!');
}

function loadGame() {
    const data = localStorage.getItem('gakuenSave');
    if (data) {
        gameState = JSON.parse(data);
        updateAll();
        renderGirls();
        alert('Wczytano!');
    } else {
        alert('Brak zapisu.');
    }
}

// ============================================================================
// START
// ============================================================================

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
